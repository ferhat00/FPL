{"cells":[{"source":"<a href=\"https://www.kaggle.com/code/ferhat00/fantasy-premier-league-using-sklearn?scriptVersionId=274270484\" target=\"_blank\"><img align=\"left\" alt=\"Kaggle\" title=\"Open in Kaggle\" src=\"https://kaggle.com/static/images/open-in-kaggle.svg\"></a>","metadata":{},"cell_type":"markdown"},{"cell_type":"code","execution_count":1,"id":"6fd941a5","metadata":{"_cell_guid":"b1076dfc-b9ad-4769-8c92-a6c4dae69d19","_uuid":"8f2839f25d086af736a60e9eeb907d3b93b6e0e5","execution":{"iopub.execute_input":"2025-11-07T14:30:46.234122Z","iopub.status.busy":"2025-11-07T14:30:46.233784Z","iopub.status.idle":"2025-11-07T14:30:48.43417Z","shell.execute_reply":"2025-11-07T14:30:48.432777Z"},"papermill":{"duration":2.207313,"end_time":"2025-11-07T14:30:48.436307","exception":false,"start_time":"2025-11-07T14:30:46.228994","status":"completed"},"tags":[]},"outputs":[],"source":["# This Python 3 environment comes with many helpful analytics libraries installed\n","# It is defined by the kaggle/python Docker image: https://github.com/kaggle/docker-python\n","# For example, here's several helpful packages to load\n","\n","import numpy as np # linear algebra\n","import pandas as pd # data processing, CSV file I/O (e.g. pd.read_csv)\n","\n","# Input data files are available in the read-only \"../input/\" directory\n","# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n","\n","import os\n","for dirname, _, filenames in os.walk('/kaggle/input'):\n","    for filename in filenames:\n","        print(os.path.join(dirname, filename))\n","\n","# You can write up to 20GB to the current directory (/kaggle/working/) that gets preserved as output when you create a version using \"Save & Run All\" \n","# You can also write temporary files to /kaggle/temp/, but they won't be saved outside of the current session"]},{"cell_type":"code","execution_count":2,"id":"03ec499e","metadata":{"execution":{"iopub.execute_input":"2025-11-07T14:30:48.443913Z","iopub.status.busy":"2025-11-07T14:30:48.44338Z","iopub.status.idle":"2025-11-07T14:30:55.655466Z","shell.execute_reply":"2025-11-07T14:30:55.654023Z"},"papermill":{"duration":7.217914,"end_time":"2025-11-07T14:30:55.657298","exception":false,"start_time":"2025-11-07T14:30:48.439384","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["Requirement already satisfied: pandas in /usr/local/lib/python3.11/dist-packages (2.2.3)\r\n","Requirement already satisfied: numpy in /usr/local/lib/python3.11/dist-packages (1.26.4)\r\n","Requirement already satisfied: scikit-learn in /usr/local/lib/python3.11/dist-packages (1.2.2)\r\n","Collecting pulp\r\n","  Downloading pulp-3.3.0-py3-none-any.whl.metadata (8.4 kB)\r\n","Requirement already satisfied: requests in /usr/local/lib/python3.11/dist-packages (2.32.5)\r\n","Requirement already satisfied: python-dateutil>=2.8.2 in /usr/local/lib/python3.11/dist-packages (from pandas) (2.9.0.post0)\r\n","Requirement already satisfied: pytz>=2020.1 in /usr/local/lib/python3.11/dist-packages (from pandas) (2025.2)\r\n","Requirement already satisfied: tzdata>=2022.7 in /usr/local/lib/python3.11/dist-packages (from pandas) (2025.2)\r\n","Requirement already satisfied: mkl_fft in /usr/local/lib/python3.11/dist-packages (from numpy) (1.3.8)\r\n","Requirement already satisfied: mkl_random in /usr/local/lib/python3.11/dist-packages (from numpy) (1.2.4)\r\n","Requirement already satisfied: mkl_umath in /usr/local/lib/python3.11/dist-packages (from numpy) (0.1.1)\r\n","Requirement already satisfied: mkl in /usr/local/lib/python3.11/dist-packages (from numpy) (2025.3.0)\r\n","Requirement already satisfied: tbb4py in /usr/local/lib/python3.11/dist-packages (from numpy) (2022.3.0)\r\n","Requirement already satisfied: mkl-service in /usr/local/lib/python3.11/dist-packages (from numpy) (2.4.1)\r\n","Requirement already satisfied: scipy>=1.3.2 in /usr/local/lib/python3.11/dist-packages (from scikit-learn) (1.15.3)\r\n","Requirement already satisfied: joblib>=1.1.1 in /usr/local/lib/python3.11/dist-packages (from scikit-learn) (1.5.2)\r\n","Requirement already satisfied: threadpoolctl>=2.0.0 in /usr/local/lib/python3.11/dist-packages (from scikit-learn) (3.6.0)\r\n","Requirement already satisfied: charset_normalizer<4,>=2 in /usr/local/lib/python3.11/dist-packages (from requests) (3.4.4)\r\n","Requirement already satisfied: idna<4,>=2.5 in /usr/local/lib/python3.11/dist-packages (from requests) (3.11)\r\n","Requirement already satisfied: urllib3<3,>=1.21.1 in /usr/local/lib/python3.11/dist-packages (from requests) (2.5.0)\r\n","Requirement already satisfied: certifi>=2017.4.17 in /usr/local/lib/python3.11/dist-packages (from requests) (2025.10.5)\r\n","Requirement already satisfied: six>=1.5 in /usr/local/lib/python3.11/dist-packages (from python-dateutil>=2.8.2->pandas) (1.17.0)\r\n","Requirement already satisfied: onemkl-license==2025.3.0 in /usr/local/lib/python3.11/dist-packages (from mkl->numpy) (2025.3.0)\r\n","Requirement already satisfied: intel-openmp<2026,>=2024 in /usr/local/lib/python3.11/dist-packages (from mkl->numpy) (2024.2.0)\r\n","Requirement already satisfied: tbb==2022.* in /usr/local/lib/python3.11/dist-packages (from mkl->numpy) (2022.3.0)\r\n","Requirement already satisfied: tcmlib==1.* in /usr/local/lib/python3.11/dist-packages (from tbb==2022.*->mkl->numpy) (1.4.0)\r\n","Requirement already satisfied: intel-cmplr-lib-rt in /usr/local/lib/python3.11/dist-packages (from mkl_umath->numpy) (2024.2.0)\r\n","Requirement already satisfied: intel-cmplr-lib-ur==2024.2.0 in /usr/local/lib/python3.11/dist-packages (from intel-openmp<2026,>=2024->mkl->numpy) (2024.2.0)\r\n","Downloading pulp-3.3.0-py3-none-any.whl (16.4 MB)\r\n","\u001b[2K   \u001b[90m‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\u001b[0m \u001b[32m16.4/16.4 MB\u001b[0m \u001b[31m67.5 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\r\n","\u001b[?25hInstalling collected packages: pulp\r\n","Successfully installed pulp-3.3.0\r\n"]}],"source":["!pip install pandas numpy scikit-learn pulp requests"]},{"cell_type":"code","execution_count":3,"id":"57dca15a","metadata":{"execution":{"iopub.execute_input":"2025-11-07T14:30:55.665759Z","iopub.status.busy":"2025-11-07T14:30:55.665404Z","iopub.status.idle":"2025-11-07T14:30:58.282709Z","shell.execute_reply":"2025-11-07T14:30:58.281487Z"},"papermill":{"duration":2.624224,"end_time":"2025-11-07T14:30:58.284917","exception":false,"start_time":"2025-11-07T14:30:55.660693","status":"completed"},"tags":[]},"outputs":[],"source":["#!/usr/bin/env python\n","# -*- coding: utf-8 -*-\n","\n","\"\"\"\n","FPL Squad Optimiser (ML + MILP) with Real FPL API Data\n","\n","* Fetches current season data from the official FPL API\n","* Trains a point‚Äëprediction model\n","* Solves a mixed‚Äëinteger linear program that respects every FPL rule\n","* Prints the optimal 15‚Äëman squad, starting 11, formation, captain,\n","  vice‚Äëcaptain, bench order and expected points.\n","\n","FIREWALL ISSUES:\n","If you get SSL certificate errors, you have two options:\n","1. Set verify_ssl=False in main() (bypasses SSL verification)\n","2. Manually download data:\n","   - Visit https://fantasy.premierleague.com/api/bootstrap-static/\n","   - Save the JSON as 'fpl_api_data.json' in the same folder\n","   - Script will auto-detect and use it\n","\n","Updated: 2025‚Äë10‚Äë08\n","\"\"\"\n","\n","from __future__ import annotations\n","\n","import json\n","import requests\n","import time\n","from collections import Counter\n","from pathlib import Path\n","from typing import List, Tuple, Dict, Any, Optional\n","\n","import numpy as np\n","import pandas as pd\n","from sklearn.ensemble import RandomForestRegressor\n","from sklearn.model_selection import train_test_split, cross_val_score\n","from sklearn.metrics import mean_absolute_error\n","import pulp\n"]},{"cell_type":"code","execution_count":4,"id":"496b4f94","metadata":{"execution":{"iopub.execute_input":"2025-11-07T14:30:58.294513Z","iopub.status.busy":"2025-11-07T14:30:58.293783Z","iopub.status.idle":"2025-11-07T14:30:58.348526Z","shell.execute_reply":"2025-11-07T14:30:58.347303Z"},"papermill":{"duration":0.062178,"end_time":"2025-11-07T14:30:58.350445","exception":false,"start_time":"2025-11-07T14:30:58.288267","status":"completed"},"tags":[]},"outputs":[],"source":["# ----------------------------------------------------------------------\n","# 1. FETCH REAL FPL DATA\n","# ----------------------------------------------------------------------\n","def fetch_fpl_data(use_cache: bool = True, verify_ssl: bool = True) -> pd.DataFrame:\n","    \"\"\"\n","    Fetch current season data from the official FPL API.\n","    \n","    Parameters\n","    ----------\n","    use_cache : bool\n","        Use cached data if available\n","    verify_ssl : bool\n","        Verify SSL certificates. Set to False if behind a firewall with SSL inspection.\n","    \n","    Returns\n","    -------\n","    pd.DataFrame\n","        One row per player with all relevant features.\n","    \"\"\"\n","    cache_file = Path(\"fpl_real_data.parquet\")\n","    \n","    # Use cached data if available and requested\n","    if use_cache and cache_file.exists():\n","        print(f\"Loading cached FPL data from {cache_file}\")\n","        return pd.read_parquet(cache_file)\n","    \n","    print(\"Fetching data from FPL API...\")\n","    if not verify_ssl:\n","        print(\"‚ö†Ô∏è  WARNING: SSL verification disabled (firewall mode)\")\n","        import urllib3\n","        urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)\n","    \n","    # Main API endpoint with all player data\n","    url = \"https://fantasy.premierleague.com/api/bootstrap-static/\"\n","    \n","    try:\n","        response = requests.get(url, timeout=30, verify=verify_ssl)\n","        response.raise_for_status()\n","        data = response.json()\n","    except requests.RequestException as e:\n","        print(f\"\\n‚ùå Failed to fetch FPL data: {e}\")\n","        print(\"\\nüí° SOLUTIONS:\")\n","        print(\"   1. Set verify_ssl=False in fetch_fpl_data() if behind a firewall\")\n","        print(\"   2. Download data manually from browser:\")\n","        print(\"      - Visit: https://fantasy.premierleague.com/api/bootstrap-static/\")\n","        print(\"      - Save as: fpl_api_data.json\")\n","        print(\"      - Run script again\")\n","        print(\"   3. Use cached data if available (set use_cache=True)\")\n","        \n","        # Try to load from manual JSON file\n","        manual_file = Path(\"fpl_api_data.json\")\n","        if manual_file.exists():\n","            print(f\"\\n‚úÖ Found manual data file: {manual_file}\")\n","            import json\n","            with open(manual_file, 'r') as f:\n","                data = json.load(f)\n","        else:\n","            raise RuntimeError(f\"Failed to fetch FPL data: {e}\")\n","    \n","    # Extract teams and positions for mapping\n","    teams = {team['id']: team['name'] for team in data['teams']}\n","    positions = {1: 'GKP', 2: 'DEF', 3: 'MID', 4: 'FWD'}\n","    \n","    # Process player data\n","    players = []\n","    for player in data['elements']:\n","        # Skip unavailable players\n","        if player['status'] not in ['a', 'd']:  # available or doubtful\n","            continue\n","            \n","        # Map injury status\n","        injury_map = {'a': 0, 'd': 1, 'i': 2, 'u': 2, 's': 2, 'n': 2}\n","        injury_status = injury_map.get(player['status'], 0)\n","        \n","        # Calculate historical points (last 3, 5, 10 games from form data)\n","        # FPL API provides points per game averages, we'll estimate\n","        form = float(player['form']) if player['form'] else 0\n","        total_points = player['total_points']\n","        \n","        # Estimate points for different windows\n","        hist_pts_3 = form * 3\n","        hist_pts_5 = form * 5\n","        hist_pts_10 = min(total_points, form * 10)\n","        \n","        # Get next fixture difficulty\n","        # FPL API returns difficulty rating (1-5)\n","        next_fixture_difficulty = 3  # default\n","        if player['event_points'] is not None:\n","            # Use average of next few fixtures\n","            selected_pct = float(player.get('selected_by_percent', '50'))\n","            next_fixture_difficulty = min(5, max(1, \n","                (player.get('difficulty', 3) + selected_pct / 20)))\n","        \n","        # Home/Away for next fixture (simplified - would need fixtures endpoint)\n","        home_away = \"Home\"  # placeholder, can be enhanced with fixtures data\n","        \n","        # Position-specific probabilities\n","        pos = positions[player['element_type']]\n","        is_gkp = pos == 'GKP'\n","        is_def = pos == 'DEF'\n","        is_mid = pos == 'MID'\n","        is_fwd = pos == 'FWD'\n","        \n","        # Clean sheet probability (for GKP and DEF)\n","        cs_prob = float(player['clean_sheets_per_90']) if is_gkp or is_def else 0.0\n","        \n","        # Goal probability and xG\n","        xg = float(player.get('expected_goals_per_90', 0))\n","        goal_prob = xg if is_fwd or is_mid else 0.0\n","        \n","        # Save points (for GKP)\n","        save_pts = float(player.get('saves_per_90', 0)) / 10 if is_gkp else 0.0\n","        \n","        # Shot conversion (for FWD)\n","        shot_conv = min(1.0, xg * 2) if is_fwd else 0.0\n","        \n","        # Team strength\n","        team_id = player['team']\n","        team_strength = data['teams'][team_id - 1]['strength']\n","        team_att = data['teams'][team_id - 1].get('strength_attack_home', 1000) / 10\n","        team_def = data['teams'][team_id - 1].get('strength_defence_home', 1000) / 10\n","        \n","        players.append({\n","            'player_id': player['id'],\n","            'name': player['web_name'],\n","            'full_name': f\"{player['first_name']} {player['second_name']}\",\n","            'team': teams[player['team']],\n","            'position': pos,\n","            'price': player['now_cost'] / 10.0,  # Convert from 10x format\n","            'hist_pts_3': hist_pts_3,\n","            'hist_pts_5': hist_pts_5,\n","            'hist_pts_10': hist_pts_10,\n","            'goals': player['goals_scored'],\n","            'assists': player['assists'],\n","            'clean_sheets': player['clean_sheets'],\n","            'bonus': player['bonus'],\n","            'opp_difficulty': next_fixture_difficulty,\n","            'home_away': home_away,\n","            'minutes_pct': (player['minutes'] / (player['starts'] * 90 * 1.0)) * 100 \n","                           if player['starts'] > 0 else 0,\n","            'influence': float(player['influence']),\n","            'creativity': float(player['creativity']),\n","            'threat': float(player['threat']),\n","            'cs_prob': cs_prob,\n","            'save_pts': save_pts,\n","            'goal_prob': goal_prob,\n","            'xg': xg,\n","            'shot_conv': shot_conv,\n","            'injury_status': injury_status,\n","            'team_att': team_att,\n","            'team_def': team_def,\n","            'form': form,\n","            'selected_by_percent': float(player['selected_by_percent']),\n","            'total_points': total_points,\n","        })\n","    \n","    df = pd.DataFrame(players)\n","    \n","    # Create synthetic \"true points\" for training\n","    # Use actual total points and form as proxy\n","    df['true_points'] = df['form'] + np.random.normal(0, 0.5, len(df))\n","    df['true_points'] = df['true_points'].clip(0, None)\n","    df['predicted_points'] = np.nan\n","    \n","    # Cache the data\n","    df.to_parquet(cache_file, index=False)\n","    print(f\"Fetched {len(df)} players from FPL API and cached to {cache_file}\")\n","    \n","    return df\n","\n","\n","def get_upcoming_fixtures(gameweek: Optional[int] = None) -> Dict[int, Dict]:\n","    \"\"\"\n","    Fetch upcoming fixture difficulty for each team.\n","    \n","    Returns\n","    -------\n","    Dict mapping team_id to fixture info (difficulty, home/away, opponent)\n","    \"\"\"\n","    url = \"https://fantasy.premierleague.com/api/fixtures/\"\n","    \n","    try:\n","        response = requests.get(url, timeout=30)\n","        response.raise_for_status()\n","        fixtures = response.json()\n","    except requests.RequestException as e:\n","        print(f\"Warning: Could not fetch fixtures: {e}\")\n","        return {}\n","    \n","    # Get current/next gameweek if not specified\n","    if gameweek is None:\n","        current_gw = next((f['event'] for f in fixtures if not f['finished']), None)\n","        gameweek = current_gw\n","    \n","    # Build fixture map\n","    fixture_map = {}\n","    for fixture in fixtures:\n","        if fixture['event'] == gameweek:\n","            # Home team\n","            fixture_map[fixture['team_h']] = {\n","                'difficulty': fixture['team_h_difficulty'],\n","                'home_away': 'Home',\n","                'opponent': fixture['team_a']\n","            }\n","            # Away team\n","            fixture_map[fixture['team_a']] = {\n","                'difficulty': fixture['team_a_difficulty'],\n","                'home_away': 'Away',\n","                'opponent': fixture['team_h']\n","            }\n","    \n","    return fixture_map\n","\n","\n","# ----------------------------------------------------------------------\n","# 2. MACHINE‚ÄëLEARNING MODEL\n","# ----------------------------------------------------------------------\n","def train_point_prediction_model(df: pd.DataFrame) -> Tuple[RandomForestRegressor, pd.DataFrame]:\n","    \"\"\"\n","    Train a RandomForestRegressor to predict next‚ÄëGW points.\n","    Returns the trained model and the dataframe with a filled\n","    ``predicted_points`` column.\n","    \"\"\"\n","    # Features\n","    feature_cols = [\n","        'hist_pts_3',\n","        'hist_pts_5',\n","        'hist_pts_10',\n","        'goals',\n","        'assists',\n","        'clean_sheets',\n","        'bonus',\n","        'opp_difficulty',\n","        'home_away',\n","        'minutes_pct',\n","        'influence',\n","        'creativity',\n","        'threat',\n","        'cs_prob',\n","        'save_pts',\n","        'goal_prob',\n","        'xg',\n","        'shot_conv',\n","        'injury_status',\n","        'team_att',\n","        'team_def',\n","    ]\n","\n","    X = df[feature_cols].copy()\n","    # Encode categorical home/away\n","    X = pd.get_dummies(X, columns=['home_away'], drop_first=True)\n","    \n","    # Fill any NaN values with 0\n","    X = X.fillna(0)\n","\n","    y = df['true_points']\n","\n","    # Train / validation split\n","    X_train, X_val, y_train, y_val = train_test_split(\n","        X, y, test_size=0.2, random_state=42\n","    )\n","\n","    model = RandomForestRegressor(\n","        n_estimators=300,\n","        max_depth=10,\n","        min_samples_leaf=2,\n","        random_state=42,\n","        n_jobs=-1,\n","    )\n","    model.fit(X_train, y_train)\n","\n","    # Validation MAE\n","    preds_val = model.predict(X_val)\n","    mae = mean_absolute_error(y_val, preds_val)\n","    print(f\"Validation MAE: {mae:.2f} points\")\n","\n","    # Cross‚Äëvalidation score\n","    cv_scores = cross_val_score(model, X, y, cv=5, scoring='neg_mean_absolute_error')\n","    print(f\"5‚Äëfold CV MAE: {-cv_scores.mean():.2f} ¬± {cv_scores.std():.2f}\")\n","\n","    # Predict for the whole data set (next GW)\n","    df['predicted_points'] = model.predict(X)\n","\n","    # Feature importance\n","    importances = pd.Series(model.feature_importances_, index=X.columns).sort_values(ascending=False)\n","    print(\"\\nTop 10 feature importances:\")\n","    print(importances.head(10))\n","\n","    return model, df\n","\n","\n","# ----------------------------------------------------------------------\n","# 3. OPTIMISATION (MILP with PuLP)\n","# ----------------------------------------------------------------------\n","def optimise_fpl_squad(df: pd.DataFrame) -> Dict[str, Any]:\n","    \"\"\"\n","    Build and solve a mixed‚Äëinteger linear program that respects **all**\n","    official FPL constraints.\n","\n","    Returns a dictionary with the solution (player IDs, formation, etc.).\n","    \"\"\"\n","    # Helper data structures\n","    player_ids = df['player_id'].tolist()\n","    price = dict(zip(player_ids, df['price']))\n","    position = dict(zip(player_ids, df['position']))\n","    team = dict(zip(player_ids, df['team']))\n","    pred_pts = dict(zip(player_ids, df['predicted_points']))\n","\n","    # Problem definition\n","    prob = pulp.LpProblem(\"FPL_Squad_Optimisation\", pulp.LpMaximize)\n","\n","    # Decision variables\n","    squad = pulp.LpVariable.dicts(\"in_squad\", player_ids, cat=\"Binary\")\n","    start = pulp.LpVariable.dicts(\"in_start\", player_ids, cat=\"Binary\")\n","    captain = pulp.LpVariable.dicts(\"captain\", player_ids, cat=\"Binary\")\n","    vice = pulp.LpVariable.dicts(\"vice\", player_ids, cat=\"Binary\")\n","\n","    # Objective: maximise predicted points + captain bonus\n","    prob += (\n","        pulp.lpSum(pred_pts[i] * (start[i] + captain[i]) for i in player_ids),\n","        \"Total_Expected_Points\",\n","    )\n","\n","    # Squad size & budget\n","    prob += pulp.lpSum(squad[i] for i in player_ids) == 15, \"Squad_Size\"\n","    prob += pulp.lpSum(price[i] * squad[i] for i in player_ids) <= 100.0, \"Budget\"\n","\n","    # Position limits for the 15‚Äëman squad\n","    pos_limits = {'GKP': 2, 'DEF': 5, 'MID': 5, 'FWD': 3}\n","    for pos, limit in pos_limits.items():\n","        prob += (\n","            pulp.lpSum(squad[i] for i in player_ids if position[i] == pos) == limit,\n","            f\"Squad_{pos}\",\n","        )\n","\n","    # Team‚Äëdiversity (max 3 from any club)\n","    for tm in df['team'].unique():\n","        prob += (\n","            pulp.lpSum(squad[i] for i in player_ids if team[i] == tm) <= 3,\n","            f\"TeamLimit_{tm}\",\n","        )\n","\n","    # Starting 11 must be subset of squad\n","    prob += pulp.lpSum(start[i] for i in player_ids) == 11, \"Start_Size\"\n","    for i in player_ids:\n","        prob += start[i] <= squad[i], f\"StartSubset_{i}\"\n","\n","    # Starting‚Äë11 formation constraints\n","    prob += (\n","        pulp.lpSum(start[i] for i in player_ids if position[i] == 'GKP') == 1,\n","        \"Start_GKP\",\n","    )\n","    prob += (\n","        pulp.lpSum(start[i] for i in player_ids if position[i] == 'DEF') >= 3,\n","        \"Start_DEF_min\",\n","    )\n","    prob += (\n","        pulp.lpSum(start[i] for i in player_ids if position[i] == 'DEF') <= 5,\n","        \"Start_DEF_max\",\n","    )\n","    prob += (\n","        pulp.lpSum(start[i] for i in player_ids if position[i] == 'MID') >= 2,\n","        \"Start_MID_min\",\n","    )\n","    prob += (\n","        pulp.lpSum(start[i] for i in player_ids if position[i] == 'MID') <= 5,\n","        \"Start_MID_max\",\n","    )\n","    prob += (\n","        pulp.lpSum(start[i] for i in player_ids if position[i] == 'FWD') >= 1,\n","        \"Start_FWD_min\",\n","    )\n","    prob += (\n","        pulp.lpSum(start[i] for i in player_ids if position[i] == 'FWD') <= 3,\n","        \"Start_FWD_max\",\n","    )\n","\n","    # Captain & Vice‚Äëcaptain (must be in starting 11, distinct)\n","    prob += pulp.lpSum(captain[i] for i in player_ids) == 1, \"One_Captain\"\n","    prob += pulp.lpSum(vice[i] for i in player_ids) == 1, \"One_Vice\"\n","    for i in player_ids:\n","        prob += captain[i] <= start[i], f\"CaptainInStart_{i}\"\n","        prob += vice[i] <= start[i], f\"ViceInStart_{i}\"\n","        prob += captain[i] + vice[i] <= 1, f\"CapViceDistinct_{i}\"\n","\n","    # Solve\n","    solver = pulp.PULP_CBC_CMD(msg=False, timeLimit=120)\n","    result_status = prob.solve(solver)\n","\n","    if pulp.LpStatus[result_status] != \"Optimal\":\n","        raise RuntimeError(\n","            f\"Optimization did not finish optimally (status: {pulp.LpStatus[result_status]})\"\n","        )\n","\n","    # Extract solution\n","    squad_ids = [i for i in player_ids if pulp.value(squad[i]) > 0.5]\n","    start_ids = [i for i in player_ids if pulp.value(start[i]) > 0.5]\n","    cap_id = next(i for i in player_ids if pulp.value(captain[i]) > 0.5)\n","    vice_id = next(i for i in player_ids if pulp.value(vice[i]) > 0.5)\n","\n","    # Bench = squad \\ start, ordered GKP first then descending predicted points\n","    bench_ids = [i for i in squad_ids if i not in start_ids]\n","    bench_ids.sort(\n","        key=lambda i: (position[i] != 'GKP', -pred_pts[i])\n","    )\n","\n","    # Determine formation\n","    formation = (\n","        f\"1-{sum(position[i] == 'DEF' for i in start_ids)}-\"\n","        f\"{sum(position[i] == 'MID' for i in start_ids)}-\"\n","        f\"{sum(position[i] == 'FWD' for i in start_ids)}\"\n","    )\n","\n","    # Expected points (including captain double‚Äëup)\n","    expected_points = sum(\n","        pred_pts[i] * (1 + (1 if i == cap_id else 0)) for i in start_ids\n","    )\n","\n","    solution = {\n","        'squad_ids': squad_ids,\n","        'start_ids': start_ids,\n","        'bench_ids': bench_ids,\n","        'captain_id': cap_id,\n","        'vice_id': vice_id,\n","        'formation': formation,\n","        'expected_points': expected_points,\n","        'total_cost': sum(price[i] for i in squad_ids),\n","    }\n","\n","    return solution\n","\n","\n","# ----------------------------------------------------------------------\n","# 4. PRESENTATION / OUTPUT\n","# ----------------------------------------------------------------------\n","def pretty_print_solution(solution: Dict[str, Any], df: pd.DataFrame) -> None:\n","    \"\"\"\n","    Nicely format the optimisation result.\n","    \"\"\"\n","    def row(pid: int) -> pd.Series:\n","        return df.loc[df['player_id'] == pid].iloc[0]\n","\n","    print(\"\\n\" + \"=\" * 70)\n","    print(\"‚öΩ  FPL OPTIMAL SQUAD (Current Season)  ‚öΩ\")\n","    print(\"=\" * 70)\n","\n","    print(f\"\\nTotal cost: ¬£{solution['total_cost']:.1f}m / ¬£100.0m\")\n","    print(f\"Expected points (incl. captain): {solution['expected_points']:.2f}\")\n","    print(f\"Formation: {solution['formation']}\")\n","\n","    print(\"\\n--- STARTING 11 \" + \"-\" * 52)\n","    for pid in solution['start_ids']:\n","        r = row(pid)\n","        cap_mark = \" (C)\" if pid == solution['captain_id'] else \"\"\n","        vice_mark = \" (VC)\" if pid == solution['vice_id'] else \"\"\n","        print(\n","            f\"{r['position']:3s} {r['name']:<18s} {r['team']:<15s} ¬£{r['price']:<4.1f}m\"\n","            f\"  Pred: {r['predicted_points']:5.2f} | Form: {r['form']:.1f}{cap_mark}{vice_mark}\"\n","        )\n","\n","    print(\"\\n--- BENCH \" + \"-\" * 60)\n","    for i, pid in enumerate(solution['bench_ids'], start=1):\n","        r = row(pid)\n","        print(\n","            f\"{i}. {r['position']:3s} {r['name']:<18s} {r['team']:<15s} ¬£{r['price']:<4.1f}m\"\n","            f\"  Pred: {r['predicted_points']:5.2f} | Form: {r['form']:.1f}\"\n","        )\n","\n","    # Team‚Äëdiversity check\n","    team_counts = Counter(df.loc[df['player_id'].isin(solution['squad_ids']), 'team'])\n","    print(\"\\n--- TEAM DIVERSITY \" + \"-\" * 50)\n","    for tm, cnt in sorted(team_counts.items(), key=lambda x: -x[1]):\n","        print(f\"{tm:<20s}: {cnt} player(s)\")\n","\n","    print(\"\\n\" + \"=\" * 70 + \"\\n\")\n","\n","\n","# ----------------------------------------------------------------------\n","# 5. MAIN / EXAMPLE USAGE\n","# ----------------------------------------------------------------------\n","def main() -> None:\n","    \"\"\"\n","    Main entry point:\n","    1. Fetch real FPL data\n","    2. Train ML model\n","    3. Optimize squad\n","    4. Display results\n","    \"\"\"\n","    print(\"=\" * 70)\n","    print(\"FPL SQUAD OPTIMIZER - Real Data Edition\")\n","    print(\"=\" * 70 + \"\\n\")\n","    \n","    # 1Ô∏è‚É£ Fetch real FPL data\n","    # If behind a firewall, set verify_ssl=False\n","    # To refresh data, set use_cache=False\n","    df_players = fetch_fpl_data(\n","        use_cache=False,      # Set to True to use cached data\n","        verify_ssl=False      # Set to False if behind firewall with SSL issues\n","    )\n","    \n","    print(f\"\\nDataset summary:\")\n","    print(f\"  Total players: {len(df_players)}\")\n","    print(f\"  By position: {df_players['position'].value_counts().to_dict()}\")\n","    print(f\"  Price range: ¬£{df_players['price'].min():.1f}m - ¬£{df_players['price'].max():.1f}m\")\n","\n","    # 2Ô∏è‚É£ Train the ML model and predict next‚ÄëGW points\n","    print(\"\\nTraining ML model...\")\n","    _, df_players = train_point_prediction_model(df_players)\n","\n","    # 3Ô∏è‚É£ Optimise squad\n","    print(\"\\nOptimizing squad...\")\n","    solution = optimise_fpl_squad(df_players)\n","\n","    # 4Ô∏è‚É£ Print results\n","    pretty_print_solution(solution, df_players)\n","    \n","    # Additional insights\n","    print(\"üí° INSIGHTS:\")\n","    cap_name = df_players.loc[df_players['player_id'] == solution['captain_id'], 'name'].iloc[0]\n","    print(f\"  ‚Ä¢ Captain pick: {cap_name}\")\n","    print(f\"  ‚Ä¢ Money remaining: ¬£{100.0 - solution['total_cost']:.1f}m\")\n","    print(f\"  ‚Ä¢ Average player price: ¬£{solution['total_cost']/15:.1f}m\")\n","    \n","    # Top predicted scorers not in squad\n","    not_selected = df_players[~df_players['player_id'].isin(solution['squad_ids'])]\n","    top_missed = not_selected.nlargest(5, 'predicted_points')[['name', 'team', 'position', 'price', 'predicted_points']]\n","    print(\"\\nüìä Top 5 predicted scorers NOT in squad:\")\n","    for _, p in top_missed.iterrows():\n","        print(f\"  ‚Ä¢ {p['name']} ({p['team']}, {p['position']}) - ¬£{p['price']:.1f}m - {p['predicted_points']:.2f} pts\")\n","\n","\n"]},{"cell_type":"code","execution_count":5,"id":"43f63b6c","metadata":{"execution":{"iopub.execute_input":"2025-11-07T14:30:58.358587Z","iopub.status.busy":"2025-11-07T14:30:58.358096Z","iopub.status.idle":"2025-11-07T14:31:04.453054Z","shell.execute_reply":"2025-11-07T14:31:04.451636Z"},"papermill":{"duration":6.100906,"end_time":"2025-11-07T14:31:04.45471","exception":false,"start_time":"2025-11-07T14:30:58.353804","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["======================================================================\n","FPL SQUAD OPTIMIZER - Real Data Edition\n","======================================================================\n","\n","Fetching data from FPL API...\n","‚ö†Ô∏è  WARNING: SSL verification disabled (firewall mode)\n","Fetched 536 players from FPL API and cached to fpl_real_data.parquet\n","\n","Dataset summary:\n","  Total players: 536\n","  By position: {'MID': 231, 'DEF': 184, 'GKP': 67, 'FWD': 54}\n","  Price range: ¬£3.8m - ¬£14.8m\n","\n","Training ML model...\n","Validation MAE: 0.40 points\n","5‚Äëfold CV MAE: 0.40 ¬± 0.03\n","\n","Top 10 feature importances:\n","hist_pts_5        0.481634\n","hist_pts_3        0.476888\n","hist_pts_10       0.006511\n","creativity        0.005424\n","influence         0.004809\n","opp_difficulty    0.003801\n","team_att          0.003056\n","minutes_pct       0.002816\n","threat            0.002709\n","team_def          0.002543\n","dtype: float64\n","\n","Optimizing squad...\n","\n","======================================================================\n","‚öΩ  FPL OPTIMAL SQUAD (Current Season)  ‚öΩ\n","======================================================================\n","\n","Total cost: ¬£99.2m / ¬£100.0m\n","Expected points (incl. captain): 103.41\n","Formation: 1-3-4-3\n","\n","--- STARTING 11 ----------------------------------------------------\n","GKP Raya               Arsenal         ¬£5.8 m  Pred:  6.31 | Form: 6.0\n","DEF Gabriel            Arsenal         ¬£6.6 m  Pred:  9.62 | Form: 11.0 (C)\n","MID Rice               Arsenal         ¬£6.8 m  Pred:  7.72 | Form: 7.7 (VC)\n","FWD Welbeck            Brighton        ¬£6.5 m  Pred:  8.50 | Form: 8.3\n","DEF James              Chelsea         ¬£5.5 m  Pred:  8.52 | Form: 8.7\n","MID Neto               Chelsea         ¬£7.1 m  Pred:  7.63 | Form: 7.7\n","FWD Mateta             Crystal Palace  ¬£7.9 m  Pred:  9.57 | Form: 9.3\n","FWD Haaland            Man City        ¬£14.8m  Pred:  9.59 | Form: 9.3\n","MID Mbeumo             Man Utd         ¬£8.4 m  Pred:  8.73 | Form: 8.7\n","MID Casemiro           Man Utd         ¬£5.5 m  Pred:  8.90 | Form: 9.0\n","DEF Van de Ven         Spurs           ¬£4.8 m  Pred:  8.68 | Form: 8.3\n","\n","--- BENCH ------------------------------------------------------------\n","1. GKP Travers            Everton         ¬£4.4 m  Pred:  0.33 | Form: 0.0\n","2. DEF Robertson          Liverpool       ¬£5.8 m  Pred:  2.88 | Form: 3.0\n","3. DEF H.Bueno            Wolves          ¬£4.4 m  Pred:  1.22 | Form: 1.0\n","4. MID Watson             Brighton        ¬£4.9 m  Pred:  0.87 | Form: 0.7\n","\n","--- TEAM DIVERSITY --------------------------------------------------\n","Arsenal             : 3 player(s)\n","Brighton            : 2 player(s)\n","Chelsea             : 2 player(s)\n","Man Utd             : 2 player(s)\n","Crystal Palace      : 1 player(s)\n","Everton             : 1 player(s)\n","Liverpool           : 1 player(s)\n","Man City            : 1 player(s)\n","Spurs               : 1 player(s)\n","Wolves              : 1 player(s)\n","\n","======================================================================\n","\n","üí° INSIGHTS:\n","  ‚Ä¢ Captain pick: Gabriel\n","  ‚Ä¢ Money remaining: ¬£0.8m\n","  ‚Ä¢ Average player price: ¬£6.6m\n","\n","üìä Top 5 predicted scorers NOT in squad:\n","  ‚Ä¢ Sessegnon (Fulham, MID) - ¬£5.4m - 6.95 pts\n","  ‚Ä¢ Mukiele (Sunderland, DEF) - ¬£4.2m - 6.82 pts\n","  ‚Ä¢ Wieffer (Brighton, MID) - ¬£4.9m - 6.81 pts\n","  ‚Ä¢ Bentancur (Spurs, MID) - ¬£5.3m - 6.73 pts\n","  ‚Ä¢ Kroupi.Jr (Bournemouth, FWD) - ¬£4.6m - 6.70 pts\n"]}],"source":["if __name__ == \"__main__\":\n","    main()"]}],"metadata":{"kaggle":{"accelerator":"none","dataSources":[],"dockerImageVersionId":31192,"isGpuEnabled":false,"isInternetEnabled":true,"language":"python","sourceType":"notebook"},"kernelspec":{"display_name":"Python 3","language":"python","name":"python3"},"language_info":{"codemirror_mode":{"name":"ipython","version":3},"file_extension":".py","mimetype":"text/x-python","name":"python","nbconvert_exporter":"python","pygments_lexer":"ipython3","version":"3.11.13"},"papermill":{"default_parameters":{},"duration":24.581267,"end_time":"2025-11-07T14:31:05.18038","environment_variables":{},"exception":null,"input_path":"__notebook__.ipynb","output_path":"__notebook__.ipynb","parameters":{},"start_time":"2025-11-07T14:30:40.599113","version":"2.6.0"}},"nbformat":4,"nbformat_minor":5}